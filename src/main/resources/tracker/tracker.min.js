(function() {
var s = document.currentScript;
var key = s.getAttribute('data-project-key');
var endpoint = s.getAttribute('data-api-endpoint') || window.location.origin + '/collect';
if (!key) return;
var heartbeatInterval = parseInt(s.getAttribute('data-heartbeat-interval')) || 30000;
var spaEnabled = s.getAttribute('data-disable-spa') !== 'true';
var sid = sessionStorage.getItem('mn_sid');
if (!sid) {
var a = new Uint8Array(16);
crypto.getRandomValues(a);
sid = Array.from(a, function(b) { return ('0' + b.toString(16)).slice(-2); }).join('');
sessionStorage.setItem('mn_sid', sid);
}
function getUtmParams() {
var params = new URLSearchParams(location.search);
var map = {utm_source:'utmSource', utm_medium:'utmMedium', utm_campaign:'utmCampaign', utm_term:'utmTerm', utm_content:'utmContent'};
var utm = {};
for (var k in map) { var v = params.get(k); if (v) utm[map[k]] = v; }
if (Object.keys(utm).length) sessionStorage.setItem('mn_utm', JSON.stringify(utm));
try { return JSON.parse(sessionStorage.getItem('mn_utm') || '{}'); } catch(e) { return {}; }
}
function send(type, eventName, extra) {
var payload = {
path: location.pathname,
referrer: document.referrer || null,
sessionId: sid,
type: type || 'pageview'
};
if (eventName) payload.eventName = eventName;
if (type === 'pageview') {
var utm = getUtmParams();
for (var k in utm) payload[k] = utm[k];
}
if (extra) { for (var k in extra) payload[k] = extra[k]; }
navigator.sendBeacon(endpoint + '?key=' + key, JSON.stringify(payload));
}
send('pageview');
var hb = setInterval(function() { send('heartbeat'); }, heartbeatInterval);
document.addEventListener('visibilitychange', function() {
if (document.hidden) {
clearInterval(hb);
} else {
hb = setInterval(function() { send('heartbeat'); }, heartbeatInterval);
}
});
var scrollThresholds = [25, 50, 75, 100];
var scrollFired = {};
function getScrollPercent() {
var h = document.documentElement;
var b = document.body;
var st = window.pageYOffset || h.scrollTop || b.scrollTop || 0;
var sh = Math.max(h.scrollHeight, b.scrollHeight) - Math.max(h.clientHeight, b.clientHeight);
return sh > 0 ? Math.round((st / sh) * 100) : 0;
}
window.addEventListener('scroll', function() {
var pct = getScrollPercent();
for (var i = 0; i < scrollThresholds.length; i++) {
var t = scrollThresholds[i];
if (pct >= t && !scrollFired[t]) {
scrollFired[t] = true;
send('scroll', null, { scrollDepth: t });
}
}
});
var fileExts = /\.(pdf|zip|xlsx?|docx?|pptx?|csv|rar|7z|tar|gz|dmg|exe|mp3|mp4|avi|mov)$/i;
document.addEventListener('click', function(e) {
var link = e.target.closest ? e.target.closest('a') : null;
if (!link || !link.href) return;
try {
var url = new URL(link.href, location.origin);
if (fileExts.test(url.pathname)) {
var fname = url.pathname.split('/').pop() || url.pathname;
send('download', fname.substring(0, 100), { targetUrl: link.href.substring(0, 1024) });
return;
}
if (url.hostname && url.hostname !== location.hostname && url.protocol.indexOf('http') === 0) {
send('outbound', url.hostname, { targetUrl: link.href.substring(0, 1024) });
}
} catch(ex) { /* ignore invalid URLs */ }
});
if (spaEnabled) {
var lastPath = location.pathname;
function onNav() {
if (lastPath !== location.pathname) {
lastPath = location.pathname;
scrollFired = {};
send('pageview');
}
}
var origPush = history.pushState;
var origReplace = history.replaceState;
history.pushState = function() { origPush.apply(this, arguments); onNav(); };
history.replaceState = function() { origReplace.apply(this, arguments); onNav(); };
window.addEventListener('popstate', onNav);
}
window.MiniNumbers = {
track: function(name, props) {
var extra = {};
if (props && typeof props === 'object') {
extra.properties = JSON.stringify(props);
}
send('custom', name, extra);
}
};
})();